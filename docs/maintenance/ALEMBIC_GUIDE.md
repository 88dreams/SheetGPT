# Alembic Database Migration Guide

## Overview

This comprehensive guide provides detailed instructions for using Alembic with the SheetGPT project, particularly when working with complex database models that have circular dependencies.

## Problem Statement

The sports database models in `src/models/sports_models.py` have circular dependencies that cause issues when running standard Alembic commands:

1. The `Team` class references the `Game` class through `home_games` and `away_games` relationships
2. The `Game` class references the `Team` class through `home_team` and `away_team` relationships
3. Several models use polymorphic `entity_id` fields that cause SQLAlchemy type evaluation issues

These circular dependencies cause errors like:

```text
TypeError: Boolean value of this clause is not defined
```

## Solution Tools

We've created a set of specialized tools to handle these issues:

1. **Alembic Wrapper Script**: `src/scripts/alembic_wrapper.py` - Bypasses circular dependencies by mocking the sports models
2. **Database Version Checker**: `src/scripts/check_alembic_status.py` - Checks the current database migration state
3. **Version Fixer**: `src/scripts/fix_alembic_version.py` - Fixes mismatched revision IDs in the database

## Using the Wrapper Script

### Basic Commands

```bash
# Check current revision
python src/scripts/alembic_wrapper.py current

# View migration history
python src/scripts/alembic_wrapper.py history

# Check available heads
python src/scripts/alembic_wrapper.py heads

# Upgrade to the latest revision
python src/scripts/alembic_wrapper.py upgrade

# Upgrade to a specific revision
python src/scripts/alembic_wrapper.py upgrade --revision 12cfdc5c6215

# Downgrade one revision
python src/scripts/alembic_wrapper.py downgrade

# Create a new revision (without autogenerate)
python src/scripts/alembic_wrapper.py revision --message "Add new feature"

# Create a new revision with autogenerate
python src/scripts/alembic_wrapper.py revision --message "Add new feature" --autogenerate
```

### Docker Environment

When running in a Docker environment, the wrapper script automatically handles the database URL conversion, replacing `db:5432` with `localhost:5432` for local development.

```bash
# Run migrations in Docker environment
docker-compose run --rm backend python src/scripts/alembic_wrapper.py upgrade
```

## Creating New Migrations

When creating a new migration:

1. Always use the wrapper script to avoid circular dependency issues:

   ```bash
   python src/scripts/alembic_wrapper.py revision --message "Your migration description" --autogenerate
   ```

2. Review the generated migration file carefully - autogenerated migrations may not capture all changes correctly, especially with complex relationships

3. Test the migration in a development environment before applying to production:

   ```bash
   python src/scripts/alembic_wrapper.py upgrade
   ```

4. Include a descriptive message that clearly indicates what changes are being made

5. Use a consistent naming convention for migration files (the wrapper script handles this automatically)

## Troubleshooting

### Mismatched Revision IDs

If you encounter errors about missing revisions, you may need to fix the Alembic version in the database:

```bash
# Check the current database version
python src/scripts/check_alembic_status.py

# Fix the version if needed
python src/scripts/fix_alembic_version.py
```

The `fix_alembic_version.py` script will:

1. Show the current version in the database
2. Ask for confirmation before making changes
3. Update the version to match the expected revision
4. Verify the update was successful

### Database Connection Issues

If you're having trouble connecting to the database, check:

1. The database URL in your settings
2. That the PostgreSQL server is running
3. That the network connection to the database is working (especially important for Docker setups)

You can verify the connection with:

```bash
# Check database connection and tables
python src/scripts/check_alembic_status.py
```

### Circular Dependency Errors

If you encounter circular dependency errors even when using the wrapper script:

1. Check if you've imported sports models directly in your code
2. Ensure you're using the latest version of the wrapper script
3. Try running with the `run_alembic_migration.py` script which uses a more comprehensive mocking approach:

   ```bash
   python src/scripts/run_alembic_migration.py
   ```

## Best Practices for Database Models

### Avoiding Circular Dependencies

When creating new models:

1. Avoid circular dependencies when possible by restructuring your models

2. Use string references for foreign keys when circular dependencies are unavoidable:

   ```python
   # Instead of this (which creates circular imports):
   home_team_id: Mapped[UUID] = mapped_column(ForeignKey("teams.id"))

   # Use this (string reference):
   home_team_id: Mapped[UUID] = mapped_column(ForeignKey("teams.id", use_alter=True))
   ```

3. For relationships with circular dependencies, use string references:

   ```python
   # Instead of this:
   home_team: Mapped["Team"] = relationship(back_populates="home_games")

   # Use this:
   home_team: Mapped["Team"] = relationship("Team", back_populates="home_games")
   ```

4. Consider using SQLAlchemy's `post_update` parameter for circular foreign keys:

   ```python
   home_team_id: Mapped[UUID] = mapped_column(ForeignKey("teams.id", use_alter=True))
   home_team: Mapped["Team"] = relationship("Team", post_update=True, back_populates="home_games")
   ```

### Testing Migrations

1. Always test migrations in a development environment before applying to production
2. Create a test database with a copy of your production schema
3. Run the migration on the test database first
4. Verify that the migration works as expected
5. Check for any data loss or corruption

## Technical Implementation

### How the Wrapper Script Works

The wrapper script (`alembic_wrapper.py`) works by:

1. Mocking the sports models during Alembic operations:

   ```python
   class MockSportsModels:
       def __getattr__(self, name):
           return None

   sys.modules['src.models.sports_models'] = MockSportsModels()
   ```

2. Handling the database URL conversion for local development:

   ```python
   if 'db:5432' in database_url:
       database_url = database_url.replace('db:5432', 'localhost:5432')
   ```

3. Providing a simple interface for common Alembic commands through a command-line interface

### Version Fixing Script

The `fix_alembic_version.py` script:

1. Connects directly to the database using SQLAlchemy
2. Checks the current version in the `alembic_version` table
3. Updates the version to match the expected revision
4. Verifies the update was successful

## Future Improvements

1. Refactor the sports models to reduce circular dependencies
2. Implement proper string references for all foreign keys
3. Add support for more complex migration scenarios
4. Create a Docker-specific migration script for container environments
5. Add automated testing for migrations
6. Implement a rollback mechanism for failed migrations

## References

- [Alembic Documentation](https://alembic.sqlalchemy.org/en/latest/)
- [SQLAlchemy Documentation on Circular Dependencies](https://docs.sqlalchemy.org/en/14/orm/self_referential.html)
- [Database Migration Best Practices](https://docs.sqlalchemy.org/en/14/core/metadata.html)
